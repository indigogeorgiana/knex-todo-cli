#!/usr/bin/env node

module.exports = {
  addTodo: addTodo,
  completeTodo: completeTodo,
  deleteTodo: deleteTodo,
  getAll: getAll,
  searchTodos: searchTodos,
  updateTodo: updateTodo
}

var config = require('./knexfile').development
var devDb = require('knex')(config)

var cmd = process.argv[2]
var note = process.argv[3]
var task = process.argv[4]

switch (cmd) {
  case 'add':
    addTodo(note)
      .then(refreshTodos)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'search':
    find(note)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'list':
    getAll()
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'done':
    completeTodo(note)
      .then(refreshTodos)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'delete':
    deleteTodo(note)
      .then(refreshTodos)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'update':
    updateTodo(note, process.argv[4])
      .then(refreshTodos)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'search':
    searchTodos(note)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'done':
    completeTodo(note)
      .then(getAll)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  case 'update':
    updateTodo(note, task)
      .then(getAll)
      .then(listTodos)
      .catch(logError)
      .finally(closeDB)
    break

  default:
    console.log('No matched cases')
    closeDB()
    break
}

function completeTodo (id, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('id', id)
    .del()
}

function updateTodo (id, task, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('id', id)
    .update({task: task})
}

function find (note, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('task', 'like', '%'+note+'%')
    .select()
}

function listTodos (todos) {
  todos.forEach(function (todo) {
    var completed = todo.completed ? ' (completed)' : ''
    console.info(todo.id + ': ' + todo.task + completed)
  })
}

function logError (err) {
  console.error('Uh oh!', err)
}

function refreshTodos () {
  return getAll()
}

function getAll (testDb) {
  const db = testDb || devDb
  return db('todos').select()
}

function addTodo (task, testDb) {
  const db = testDb || devDb
  return db('todos')
    .insert({
      task: task
    })
}

function completeTodo (id, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('id', id)
    .update({ completed: true })
}

function deleteTodo (id, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('id', id)
    .delete()
}

function updateTodo (id, task, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('id', id)
    .update({ task: task })
}

function searchTodos (search, testDb) {
  const db = testDb || devDb
  return db('todos')
    .where('task', 'like', '%' + search + '%')
    .select()
}

function closeDB (testDb) {
  const db = testDb || devDb
  db.destroy()
}

